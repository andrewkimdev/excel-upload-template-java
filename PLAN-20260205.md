# Plan: Error Feedback File Format Preservation

**Date**: 2026-02-05
**Status**: Ready for implementation

## Summary

Rewrite the error report generation to use SXSSFWorkbook (full rebuild), preserve cell formatting, fix XLS→XLSX conversion style copying, thread the original filename through to download, and add a disclaimer at the bottom of the error sheet.

### Context & Motivation

The current error report returns a file where "all the formats are gone." Two root causes:
1. **XLS→XLSX conversion** (`ExcelConversionService.convertWorkbook()`) copies only cell values and merged regions — all styles, fonts, borders, column widths, row heights are discarded.
2. **Error cell highlighting** (`ExcelErrorReportService`) replaces each error cell's style entirely with a bare ROSE-fill style, destroying original formatting (font, borders, number format, etc.).

Additionally, the download filename is `errors_{UUID}.xlsx` — unrecognizable to users.

### Technical constraint: SXSSFWorkbook

Code reviewer requires SXSSFWorkbook for all Excel writing. However, SXSSFWorkbook **cannot modify existing rows/cells** (silently corrupts output per POI 5.4.1 docs). Solution: **full rebuild** — read original read-only, stream-write a new copy with annotations.

---

## Phase 1: Create `WorkbookCopyUtils` (new file, no dependencies)

**File**: `src/main/java/com/foo/excel/util/WorkbookCopyUtils.java`

Stateless utility class (like `SecureExcelUtils` — `final class`, private constructor, static methods). Used by both the error report service and the XLS conversion service.

### Methods

1. **`buildStyleMapping(Workbook source, Workbook target)`** → `Map<Integer, CellStyle>`
   - Iterate `source.getNumCellStyles()` styles
   - Index 0: modify `target.getCellStyleAt(0)` in place via `cloneStyleFrom()` (default style already exists in every new workbook)
   - Index > 0: `target.createCellStyle()` + `cloneStyleFrom()`
   - `cloneStyleFrom()` handles both HSSF→XSSF and XSSF→XSSF cross-format copying

2. **`getOrCreateErrorStyle(Workbook wb, CellStyle base, Map<Integer, CellStyle> cache)`** → `CellStyle`
   - Cache key: `base.getIndex()` — prevents style explosion (POI's 64K style-per-workbook limit)
   - Clone base style, set `IndexedColors.ROSE` fill foreground + `FillPatternType.SOLID_FOREGROUND`

3. **`copyCellValue(Cell source, Cell target)`**
   - Java 17 switch expression over `CellType`: STRING, NUMERIC (with `DateUtil.isCellDateFormatted` check for dates), BOOLEAN, FORMULA, BLANK, ERROR

4. **`copyColumnWidths(Sheet source, Sheet target, int maxCol)`**
   - Copy `columnWidth` and `columnHidden` for columns 0..maxCol
   - Copy `defaultColumnWidth` and `defaultRowHeight`

5. **`copyMergedRegions(Sheet source, Sheet target)`**
   - Iterate `source.getMergedRegions()`, add each to target

### Test: `src/test/java/com/foo/excel/util/WorkbookCopyUtilsTest.java`
- Style mapping preserves font/fill/borders (XSSF→XSSF and HSSF→XSSF)
- Default style (index 0) modified in place, not duplicated
- Error style has ROSE fill + caches by base style index
- `copyCellValue` for every CellType including date-formatted NUMERIC
- Column widths and merged regions copied correctly

---

## Phase 2: Rewrite `ExcelErrorReportService` (depends on Phase 1)

**File**: `src/main/java/com/foo/excel/service/ExcelErrorReportService.java`

### Signature change
```java
// Add 5th parameter:
public Path generateErrorReport(Path originalXlsx, ExcelValidationResult validationResult,
        List<ColumnMapping> columnMappings, ExcelImportConfig config,
        String originalFilename) throws IOException
```

### Algorithm (complete method body rewrite)

1. **Open source read-only** via `SecureExcelUtils.createWorkbook()` — no longer needs `WorkbookFactory.create()` with write access. This is a security improvement.
2. **Create target** `XSSFWorkbook`, build style map via `WorkbookCopyUtils.buildStyleMapping()`
3. **Build error lookup**: `Map<Integer, RowError>` keyed by 1-based row number for O(1) access
4. **Wrap with `SXSSFWorkbook(targetXssf, 100)`** — 100-row window, sequential top-to-bottom write
5. **For EACH sheet** in source workbook:
   - `sxssfWorkbook.createSheet(sourceSheetName)`
   - Copy merged regions and column widths via `WorkbookCopyUtils` (sheet-level metadata, not affected by SXSSF row window)
   - Stream-copy all rows top-to-bottom:
     - Copy row height
     - Copy each cell value + mapped style
   - **On the data sheet only** (`config.getSheetIndex()`):
     - Header row: add `_ERRORS` column header cell with bold font
     - Error rows: apply `getOrCreateErrorStyle()` to error cells (clone original + red) + write formatted error message in `_ERRORS` column (sanitized via `SecureExcelUtils.sanitizeForExcelCell()`)
6. **Add disclaimer** on data sheet, 2 blank rows below last data row:
   - Text: `※ 본 파일은 오류 확인용으로 재생성되었습니다. 일부 서식 및 기능이 원본 파일과 다를 수 있습니다.`
   - Merged across data columns, italic gray font (`IndexedColors.GREY_50_PERCENT`)
   - Note: starts with `※` which conveniently acts as a footer stop marker if someone re-uploads the error report
7. **Write** via `sxssfWorkbook.write(os)`, then `sxssfWorkbook.dispose()` to clean up SXSSF temp files
8. **Save `.meta` file** (`{UUID}.meta`) alongside error XLSX containing the original filename
   - Auto-cleaned by existing `TempFileCleanupService` (walks all files by age — no changes needed)

### Key design decisions
- Source opened read-only → better security, aligns with `SecureExcelUtils.createWorkbook()` pattern
- All sheets copied (not just data sheet) → preserves multi-sheet workbooks
- Error style cache keyed by source style index → prevents 64K limit explosion
- `dispose()` must be called even on exceptions → use finally block
- Removed dependency on `WorkbookFactory` (was the only reason for write access)

### Tests to update: `src/test/java/com/foo/excel/service/ExcelErrorReportServiceTest.java`
- All 7 existing tests: add 5th `originalFilename` parameter to `generateErrorReport()` calls
- New tests:
  - Error cells retain original formatting (font/borders) PLUS ROSE fill
  - All sheets copied from multi-sheet source workbook
  - Column widths preserved
  - Disclaimer row exists with correct Korean text, merged cells, italic gray style
  - `.meta` file written when originalFilename provided
  - `.meta` file NOT written when originalFilename is null
  - Output is valid XLSX

---

## Phase 3: Fix `ExcelConversionService.convertWorkbook()` (depends on Phase 1, parallel with Phase 2)

**File**: `src/main/java/com/foo/excel/service/ExcelConversionService.java`

### Changes to `convertWorkbook(HSSFWorkbook)` method
- Build style mapping via `WorkbookCopyUtils.buildStyleMapping(hssfWorkbook, xssfWorkbook)`
- Copy column widths via `WorkbookCopyUtils.copyColumnWidths()`
- Copy row heights: `xssfRow.setHeight(hssfRow.getHeight())`
- Apply mapped styles to each cell: `xssfCell.setCellStyle(styleMap.get(...))`
- Replace private `copyCellValue()` method with `WorkbookCopyUtils.copyCellValue()` call
- Delete the old private `copyCellValue()` method (currently at lines 129-139)

### Tests: `src/test/java/com/foo/excel/service/ExcelConversionServiceTest.java`
- XLS conversion preserves cell styles (bold, italic, borders, colors)
- Column widths preserved
- Row heights preserved
- Date-formatted cells survive conversion

---

## Phase 4: Thread original filename (depends on Phase 2)

**File**: `src/main/java/com/foo/excel/service/ExcelImportOrchestrator.java`

1. **Add field to `ImportResult`** inner class: `private String originalFilename;`
2. **In `doProcess()`**: extract `file.getOriginalFilename()`, sanitize via `SecureExcelUtils.sanitizeFilename()` (catch `IllegalArgumentException` → null fallback, log warning)
3. **Pass to error report**: add sanitized filename as 5th argument to `generateErrorReport()`
4. **Set on ImportResult**: `.originalFilename(sanitizedFilename)` in the error-case builder chain

---

## Phase 5: Use original filename in download (depends on Phase 4)

**File**: `src/main/java/com/foo/excel/controller/ExcelUploadController.java`

### Changes to `downloadErrorFile()` method
1. After UUID validation and file existence check, read `{fileId}.meta` from errors directory
2. If meta exists and non-blank: build filename as `오류_{originalName}.xlsx` (normalize `.xls` extension → `.xlsx`)
3. If meta missing or blank: fallback to current `errors_{UUID}.xlsx`
4. Use RFC 5987 encoding for Korean characters in Content-Disposition:
   ```
   attachment; filename="<UUID>.xlsx"; filename*=UTF-8''<URL-encoded-korean-name>
   ```
   - `filename=` is ASCII fallback for old browsers
   - `filename*=UTF-8''...` is URL-encoded UTF-8 for modern browsers

---

## Implementation order

```
Phase 1: WorkbookCopyUtils ─────────┐
                                     ├──→ Phase 2: ExcelErrorReportService
                                     │         │
                                     │         └──→ Phase 4: Orchestrator
                                     │                   │
                                     │                   └──→ Phase 5: Controller
                                     │
                                     └──→ Phase 3: ExcelConversionService (parallel with 2)
```

---

## Files summary

| File | Action | Phase |
|------|--------|-------|
| `src/main/java/com/foo/excel/util/WorkbookCopyUtils.java` | **CREATE** | 1 |
| `src/test/java/com/foo/excel/util/WorkbookCopyUtilsTest.java` | **CREATE** | 1 |
| `src/main/java/com/foo/excel/service/ExcelErrorReportService.java` | REWRITE | 2 |
| `src/test/java/com/foo/excel/service/ExcelErrorReportServiceTest.java` | UPDATE | 2 |
| `src/main/java/com/foo/excel/service/ExcelConversionService.java` | MODIFY | 3 |
| `src/test/java/com/foo/excel/service/ExcelConversionServiceTest.java` | UPDATE/CREATE | 3 |
| `src/main/java/com/foo/excel/service/ExcelImportOrchestrator.java` | MODIFY | 4 |
| `src/main/java/com/foo/excel/controller/ExcelUploadController.java` | MODIFY | 5 |

---

## Verification

1. `./gradlew test` — all existing + new tests pass
2. `./gradlew build` — clean build
3. Manual test: upload a styled XLSX with intentional errors → download error report → verify:
   - Original cell formatting (fonts, borders, colors) preserved
   - Error cells have red background ON TOP of original style
   - `_ERRORS` column with formatted messages
   - Disclaimer at bottom of sheet
   - Download filename uses original name with `오류_` prefix
4. Manual test: upload a styled XLS → verify formatting survives conversion + error report

---

## Risks and mitigations

| Risk | Mitigation |
|------|------------|
| SXSSF flushes rows, preventing re-access | Write sequentially; error annotations applied during same-row iteration |
| `cloneStyleFrom()` color quirks (HSSF→XSSF) | Acceptable for XLS conversion; disclaimer covers edge cases |
| Style count explosion from error highlighting | Cache keyed by source style index; real workbooks have <1000 unique styles |
| `SXSSFWorkbook.dispose()` not called on exception | Place in finally block |
| Orphaned `.meta` files | Existing `TempFileCleanupService` deletes all files by age |
| Old error reports lack `.meta` files | Controller falls back to UUID-based naming |
