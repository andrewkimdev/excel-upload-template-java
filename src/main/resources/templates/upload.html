<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Upload</title>
    <link rel="stylesheet" th:href="@{/style.css}">
</head>
<body>
    <div class="container">
        <h1>Excel File Upload</h1>

        <!--
        SECURITY NOTES FOR CONSUMERS:
        =============================
        1. CSRF Protection: When integrating Spring Security, add a CSRF token:
           <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        2. Authentication: This form should only be accessible to authenticated users.
           Add Spring Security and configure access control for this endpoint.

        3. File Validation: The backend validates file content (magic bytes), but
           client-side validation with 'accept' attribute provides UX improvement only.
           Never rely solely on client-side validation for security.
        -->
        <form method="post" th:action="@{/upload}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="templateType">Template Type</label>
                <select id="templateType" name="templateType" required>
                    <option value="tariff-exemption">Tariff Exemption (관세면제)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="file">Excel File (.xlsx)</label>
                <!--
                SECURITY: The 'accept' attribute is for UX only and can be bypassed.
                Server-side validation (magic bytes check) provides actual security.
                -->
                <input type="file" id="file" name="file" accept=".xlsx" required>
            </div>

            <button type="submit">Upload</button>
        </form>

        <!--
        SECURITY WARNING: H2 Console Section
        =====================================
        The H2 console and auto-login functionality below are for DEVELOPMENT ONLY.
        Before deploying to production:
        1. Remove this entire section (lines 46-80)
        2. Disable H2 console in application.properties: spring.h2.console.enabled=false
        3. Use a production database with proper credentials

        The H2 console provides full SQL access and can be used to:
        - Read/modify/delete all data
        - Execute arbitrary SQL including system commands via RUNSCRIPT
        - Potentially achieve remote code execution

        NEVER expose H2 console in production environments.
        -->
        <hr style="margin-top:2rem;">
        <button type="button" onclick="openH2Console()" class="h2-console-btn">
            Open H2 Database Console
        </button>
        <p class="h2-hint">
            JDBC URL: <code>jdbc:h2:mem:testdb</code> &nbsp;|&nbsp; User: <code>sa</code> &nbsp;|&nbsp; Password: <em>(empty)</em>
        </p>
    </div>

    <script>
        // SECURITY WARNING: This auto-login script is for DEVELOPMENT ONLY.
        // It exposes database credentials and should be removed for production.
        function openH2Console() {
            // Step 1: GET /h2-console/ to establish a session and obtain jsessionid
            fetch('/h2-console/')
                .then(function (resp) { return resp.text(); })
                .then(function (html) {
                    var match = html.match(/jsessionid=([a-f0-9]+)/);
                    if (!match) { window.open('/h2-console', 'h2console'); return; }
                    var sid = match[1];

                    // Step 2: POST login credentials using that session
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/h2-console/login.do?jsessionid=' + sid;
                    form.target = 'h2console';

                    var fields = {
                        language: 'en',
                        setting: 'Generic H2 (Embedded)',
                        name: 'Generic H2 (Embedded)',
                        driver: 'org.h2.Driver',
                        url: 'jdbc:h2:mem:testdb',
                        user: 'sa',
                        password: ''
                    };

                    for (var key in fields) {
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = fields[key];
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    form.submit();
                    document.body.removeChild(form);
                })
                .catch(function () { window.open('/h2-console', 'h2console'); });
        }
    </script>
</body>
</html>
